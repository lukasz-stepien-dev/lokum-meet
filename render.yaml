services:
  # 1. Baza danych (Render Managed PostgreSQL)
  # Render zarządza bazą za nas, jest wydajniejsza niż kontener Docker
  - type: psql
    name: community-events-db
    env: docker
    plan: free # Dostępny plan darmowy
    databaseName: community_events_dev
    user: postgres

  # 2. MinIO (Object Storage)
  # W Renderze kontenery są ulotne, więc musimy dodać DYSK, aby dane przetrwały restart.
  - type: web
    name: community-events-minio
    runtime: docker
    # Wskazujemy obraz bezpośrednio z Docker Hub/Quay, nie budujemy go
    image: quay.io/minio/minio:latest
    plan: free
    envVars:
      - key: MINIO_ROOT_USER
        value: minio
      - key: MINIO_ROOT_PASSWORD
        generateValue: true # Render wygeneruje bezpieczne hasło
      - key: PORT
        value: 9000
    disk:
      name: minio-data
      mountPath: /data
      sizeGB: 1
    startCommand: server /data --console-address ":9001" --address ":9000"
    # UWAGA: Render udostępnia publicznie tylko jeden port. Tutaj będzie to API (9000).
    # Konsola (9001) nie będzie dostępna z zewnątrz w darmowym planie w prosty sposób.

  # 3. Backend (Spring Boot)
  - type: web
    name: community-events-backend
    runtime: docker
    context: backend # Wskazujemy folder backendu jako kontekst budowania
    dockerfilePath: ./Dockerfile # Ścieżka wewnątrz folderu backend
    plan: free
    envVars:
      - key: SPRING_APPLICATION_NAME
        value: community-events
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: PORT
        value: 8080
      # Połączenie do bazy danych (Render wstrzyknie DATABASE_URL automatycznie, ale Spring woli JDBC)
      - key: SPRING_DATASOURCE_URL
        fromDatabase:
          name: community-events-db
          property: connectionString
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: community-events-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: community-events-db
          property: password
      # Konfiguracja MinIO (Internal URL jest szybszy i darmowy wewnątrz sieci Render)
      - key: MINIO_URL
        fromService:
          type: web
          name: community-events-minio
          env: PORT # Zwróci np. host:9000
          value: "http://${host}:${port}" # Render podstawi hosta wewnętrznego
      - key: MINIO_ACCESS_KEY
        value: minio
      - key: MINIO_SECRET_KEY
        fromService:
          type: web
          name: community-events-minio
          env: MINIO_ROOT_PASSWORD
      - key: JWT_SECRET
        generateValue: true

  # 4. Frontend (Next.js)
  - type: web
    name: community-events-frontend
    runtime: docker
    context: frontend
    dockerfilePath: ./Dockerfile
    plan: free
    envVars:
      - key: PORT
        value: 3000
      # To musi być PUBLICZNY URL backendu, bo frontend działa w przeglądarce użytkownika
      - key: VITE_API_BASE_URL
        fromService:
          type: web
          name: community-events-backend
          env: RENDER_EXTERNAL_URL # Publiczny URL backendu (https://...)
      # URL do obrazków (publiczny)
      - key: VITE_MINIO_URL
        fromService:
          type: web
          name: community-events-minio
          env: RENDER_EXTERNAL_URL

databases:
  - name: community-events-db
    databaseName: community_events_dev
    user: postgres
    plan: free